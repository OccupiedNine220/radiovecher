import os
import sys
import logging
import asyncio
import discord
from discord.ext import commands
from dotenv import load_dotenv
from music_player import MusicPlayer
from lavalink_player import LavalinkPlayer
from config import radios

# ­Ъїљ лўлюлЪлълалб лњлЋлЉ-лАлЋлалњлЋлалљ - лЉлЋлЌ лЮлЋлЊлъ лЮлўлДлЋлЊлъ лЮлЋ лалљлЉлълблљлЋлб!!! ­Ъїљ
try:
    from web.server import initialize_web_server, get_web_url
    WEB_ENABLED = True
except ImportError:
    print("Рџа№ИЈ лњлЋлЉ-лАлЋлалњлЋла лЮлЋ лЌлљлЊлалБлќлЋлЮ!!! лЪлалълњлЋлалглблЋ лЮлљлЏлўлДлўлЋ лћлўлалЋлџлблълалўлў 'web' лў лЌлљлњлўлАлўлюлълАлблЋлЎ!!! Рџа№ИЈ")
    WEB_ENABLED = False

# ­ЪЊЮ лЮлљлАлблалълЎлџлљ лЏлълЊлўлалълњлљлЮлўл» - лњлљлќлЮлъ лћлЏл» лълблАлЏлЋлќлўлњлљлЮлўл» лАлълЉлФлблўлЎ!!! ­ЪЊЮ
logging.basicConfig(level=logging.INFO, 
                   format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger('bot')

# ­ЪћЉ лЌлљлЊлалБлЌлџлљ лЪлЋлалЋлюлЋлЮлЮлФлЦ лълџлалБлќлЋлЮлўл» - лЉлЋлЌ лГлблълЊлъ лЉлълб лЮлЋ лЌлљлЪлБлАлблўлблАл»!!! ­ЪћЉ
load_dotenv()

# ­Ъј» лЪлълЏлБлДлЋлЮлўлЋ лблълџлЋлЮлљ лЉлълблљ - лџлалўлблўлДлЋлАлџлў лњлљлќлЮлъ!!! ­Ъј»
TOKEN = os.getenv('BOT_TOKEN')
if not TOKEN:
    logger.error("РЮї лблълџлЋлЮ лЉлълблљ лЮлЋ лЮлљлЎлћлЋлЮ!!! лЪлалълњлЋлалглблЋ лцлљлЎлЏ .env!!! РЮї")
    sys.exit(1)

# РџЎ№ИЈ лЮлљлАлблалълЎлџлљ LAVALINK - лћлЏл» лўлћлЋлљлЏлглЮлълЊлъ лџлљлДлЋлАлблњлљ лЌлњлБлџлљ!!! РџЎ№ИЈ
USE_LAVALINK = os.getenv('USE_LAVALINK', 'false').lower() == 'true'
DEFAULT_VOLUME = int(os.getenv('DEFAULT_VOLUME', '50'))
DEFAULT_RADIO = os.getenv('DEFAULT_RADIO', 'relax')

# ­ЪћЇ лЪлалълњлЋлалџлљ лблълџлЋлЮлљ - лќлўлЌлЮлЋлЮлЮлъ лЮлЋлълЉлЦлълћлўлюлъ!!! ­ЪћЇ
if not TOKEN:
    print("РЮї лълелўлЉлџлљ: лблълџлЋлЮ лЉлълблљ лЮлЋ лЮлљлЎлћлЋлЮ лњ .env лцлљлЎлЏлЋ!!! лЮлЋлюлЋлћлЏлЋлЮлЮлъ лўлАлЪлалљлњлглблЋ!!! РЮї")
    sys.exit(1)

# ­ЪДа лЮлљлАлблалълЎлџлљ лўлЮлблЋлЮлблълњ лЉлълблљ - лњлАлЋ лћлълЏлќлЮлФ лЉлФлблг лњлџлЏл«лДлЋлЮлФ!!! ­ЪДа
intents = discord.Intents.default()
intents.message_content = True
intents.voice_states = True
intents.guilds = True
intents.members = True

# ­Ъцќ лАлълЌлћлљлЮлўлЋ лГлџлЌлЋлюлЪлЏл»лалљ лЉлълблљ - лълАлЮлълњлљ лњлАлЋлЊлъ лЪлалълЋлџлблљ!!! ­Ъцќ
bot = commands.Bot(command_prefix=os.getenv('COMMAND_PREFIX', '/'), intents=intents)

# ­Ъјх лАлЏлълњлљлалг лћлЏл» лЦлалљлЮлЋлЮлўл» люлБлЌлФлџлљлЏлглЮлФлЦ лЪлЏлЋлЋлалълњ - лџлљлќлћлълюлБ лАлЋлалњлЋлалБ лАлњлълЎ!!! ­Ъјх
bot.players = {}

# ­ЪЊ╗ лЮлљлАлблалълЎлџлљ лћлълАлблБлЪлЮлФлЦ лалљлћлўлълАлблљлЮлдлўлЎ - лблълЏлглџлъ лЏлБлДлелўлЋ лАлблљлЮлдлўлў!!! ­ЪЊ╗
bot.available_radios = radios
bot.current_radio = bot.available_radios.get(DEFAULT_RADIO, list(bot.available_radios.values())[0])

# ­Ъћё лЪлЋлалЋлџлЏл«лДлЋлЮлўлЋ лЮлљ лћлалБлЊлБл« лалљлћлўлълАлблљлЮлдлўл« - люлЊлЮлълњлЋлЮлЮлљл» лАлюлЋлЮлљ лЮлљлАлблалълЋлЮлўл»!!! ­Ъћё
def switch_radio(radio_key):
    """­Ъћђ лЪлЋлалЋлџлЏл«лДлЋлЮлўлЋ лЮлљ лћлалБлЊлБл« лалљлћлўлълАлблљлЮлдлўл« - лњлФлЉлўлалљлЎ лЏл«лЉлўлюлБл« люлБлЌлФлџлБ!!! ­Ъћђ"""
    if radio_key in bot.available_radios:
        bot.current_radio = bot.available_radios[radio_key]
        return bot.current_radio
    return None

# ­ЪњЙ лАлълЦлалљлЮлЋлЮлўлЋ лцлБлЮлџлдлўлў лЪлЋлалЋлџлЏл«лДлЋлЮлўл» лалљлћлўлълАлблљлЮлдлўлЎ лњ лГлџлЌлЋлюлЪлЏл»лалЋ лЉлълблљ!!! ­ЪњЙ
bot.switch_radio = switch_radio

@bot.event
async def on_ready():
    """РюЁ лњлФлЌлФлњлљлЋлблАл» лЪлалў лБлАлЪлЋлелЮлълю лЌлљлЪлБлАлџлЋ лЉлълблљ - лАлљлюлФлЎ лњлљлќлЮлФлЎ люлълюлЋлЮлб!!! РюЁ"""
    logger.info(f'­Ъџђ лЉлълб лЌлљлЪлБлЕлЋлЮ лџлљлџ {bot.user.name}#{bot.user.discriminator}!!! лалљлћлБлЎлАл»!!! ­Ъџђ')
    logger.info(f'­Ъєћ ID лЉлълблљ: {bot.user.id}!!! лЌлљлЪлълюлЮлў лЋлЊлъ лЮлљ лњлАл»лџлўлЎ лАлЏлБлДлљлЎ!!! ­Ъєћ')
    logger.info(f'­ЪїЇ лџлълЏ-лњлъ лАлЋлалњлЋлалълњ: {len(bot.guilds)}!!! лАлџлълалъ лЉлБлћлЋлб лЉлълЏлглелЋ!!! ­ЪїЇ')
    
    # ­ЪјГ лБлАлблљлЮлљлњлЏлўлњлљлЋлю лАлблљлблБлА - лЪлБлАлблг лњлАлЋ лњлўлћл»лб, лДлблъ лЉлълб лџлалБлблълЎ!!! ­ЪјГ
    await bot.change_presence(
        activity=discord.Activity(
            type=discord.ActivityType.listening, 
            name=f"/help | {bot.current_radio['name']}"
        )
    )

    # ­Ъїљ лЌлљлЪлБлАлџ лњлЋлЉ-лАлЋлалњлЋлалљ - лћлЏл» лБлћлълЉлЮлълЊлъ лБлЪлалљлњлЏлЋлЮлўл»!!! ­Ъїљ
    server.initialize_web_server(bot)
    
    logger.info(f'­Ъїљ лњлЋлЉ-лАлЋлалњлЋла лЌлљлЪлБлЕлЋлЮ лЪлъ лљлћлалЋлАлБ: {server.get_web_url()}!!! лълблџлалълЎ лњ лЉлалљлБлЌлЋлалЋ!!! ­Ъїљ')

@bot.event
async def on_voice_state_update(member, before, after):
    """­ЪЉѓ лълЉлалљлЉлълблДлўлџ лўлЌлюлЋлЮлЋлЮлўлЎ лАлълАлблъл»лЮлўл» лЊлълЏлълАлълњлФлЦ лџлљлЮлљлЏлълњ - лАлЏлЋлћлўлю лЌлљ лњлАлЋлю!!! ­ЪЉѓ"""
    # ­ЪћЇ лЪлалълњлЋлал»лЋлю, лълблЮлълАлўлблАл» лЏлў лГлблъ лўлЌлюлЋлЮлЋлЮлўлЋ лџ лЉлълблБ!!! ­ЪћЇ
    if member.id == bot.user.id:
        # ­Ъћї лЋлАлЏлў лЉлълб лълблџлЏл«лДлўлЏлАл» лълб лЊлълЏлълАлълњлълЊлъ лџлљлЮлљлЏлљ!!! ­Ъћї
        if before.channel and not after.channel:
            guild_id = before.channel.guild.id
            # ­ЪЌЉ№ИЈ лБлћлљлЏл»лЋлю лЪлЏлЋлЋла лћлЏл» лГлблълЎ лЊлўлЏлглћлўлў, лЋлАлЏлў лълЮ лАлБлЕлЋлАлблњлБлЋлб!!! ­ЪЌЉ№ИЈ
            if guild_id in bot.players:
                player = bot.players[guild_id]
                await player.cleanup()
                del bot.players[guild_id]
                logger.info(f'­ЪД╣ лЪлЏлЋлЋла лБлћлљлЏлЋлЮ лћлЏл» лАлЋлалњлЋлалљ {guild_id} лЪлълАлЏлЋ лълблџлЏл«лДлЋлЮлўл» лълб лџлљлЮлљлЏлљ!!! ­ЪД╣')

# ­ЪЊџ лЌлљлЊлалБлЌлџлљ лџлълЊлълњ лА лџлълюлљлЮлћлљлюлў - люлЮлълќлЋлАлблњлъ лБлћлълЉлЮлФлЦ лцлБлЮлџлдлўлЎ!!! ­ЪЊџ
async def load_extensions():
    """­ЪЊЦ лЌлљлЊлалБлЌлџлљ люлълћлБлЏлЋлЎ лА лџлълюлљлЮлћлљлюлў - лалљлАлелўлал»лЋлю лњлълЌлюлълќлЮлълАлблў лЉлълблљ!!! ­ЪЊЦ"""
    try:
        # ­ЪЊѓ лЌлљлЊлалБлЌлџлљ лњлАлЋлЦ лџлълЊлълњ лўлЌ лЪлљлЪлџлў COGS!!! ­ЪЊѓ
        for filename in os.listdir('./cogs'):
            if filename.endswith('.py'):
                await bot.load_extension(f'cogs.{filename[:-3]}')
                logger.info(f'­ЪЊд лЌлљлЊлалБлќлЋлЮ люлълћлБлЏлг: cogs.{filename[:-3]}!!! лЋлЕлЋ лЉлълЏлглелЋ лцлБлЮлџлдлўлЎ!!! ­ЪЊд')
    except Exception as e:
        logger.error(f'РЮї лълелўлЉлџлљ лЪлалў лЌлљлЊлалБлЌлџлЋ люлълћлБлЏлЋлЎ: {e}!!! лАлалълДлЮлъ лўлАлЪлалљлњлглблЋ!!! РЮї')

# ­Ъј« лцлБлЮлџлдлўл» лћлЏл» лЪлълЏлБлДлЋлЮлўл» лЪлълћлЦлълћл»лЕлЋлЊлъ лЪлЏлЋлЋлалљ лћлЏл» лЊлўлЏлглћлўлў!!! ­Ъј«
async def get_player(guild):
    """­ЪјД лњлълЌлњлалљлЕлљлЋлб лГлџлЌлЋлюлЪлЏл»ла лЪлЏлЋлЋлалљ лћлЏл» лЊлўлЏлглћлўлў - лБлЮлўлџлљлЏлглЮлФлЎ лћлЏл» лџлљлќлћлълЊлъ лАлЋлалњлЋлалљ!!! ­ЪјД"""
    guild_id = guild.id
    
    # ­ЪћЇ лЋлАлЏлў лЪлЏлЋлЋла лБлќлЋ лАлБлЕлЋлАлблњлБлЋлб, лњлълЌлњлалљлЕлљлЋлю лЋлЊлъ!!! ­ЪћЇ
    if guild_id in bot.players:
        return bot.players[guild_id]
    
    # ­ЪєЋ лўлЮлљлДлЋ лАлълЌлћлљлЋлю лЮлълњлФлЎ лЪлЏлЋлЋла - лАлљлюлФлЎ лЏлБлДлелўлЎ лњ люлўлалЋ!!! ­ЪєЋ
    if USE_LAVALINK:
        logger.info(f'­Ъјх лАлълЌлћлљлЮлўлЋ LavalinkPlayer лћлЏл» лАлЋлалњлЋлалљ {guild.name} (id: {guild_id})!!! лўлћлЋлљлЏлглЮлълЋ лџлљлДлЋлАлблњлъ лЌлњлБлџлљ!!! ­Ъјх')
        player = LavalinkPlayer(bot, guild)
    else:
        logger.info(f'­Ъјх лАлълЌлћлљлЮлўлЋ MusicPlayer лћлЏл» лАлЋлалњлЋлалљ {guild.name} (id: {guild_id})!!! лњлЋлЏлўлџлълЏлЋлЪлЮлълЋ лЌлњлБлДлљлЮлўлЋ!!! ­Ъјх')
        player = MusicPlayer(bot, guild)
    
    # ­Ъћі лБлАлблљлЮлљлњлЏлўлњлљлЋлю лЊлалълюлџлълАлблг - лњ лАлљлюлФлЎ лалљлЌ!!! ­Ъћі
    await player.set_volume(DEFAULT_VOLUME)
    
    # ­ЪњЙ лАлълЦлалљлЮл»лЋлю лЪлЏлЋлЋла - лћлЏл» лЉлБлћлБлЕлЋлЊлъ лўлАлЪлълЏлглЌлълњлљлЮлўл»!!! ­ЪњЙ
    bot.players[guild_id] = player
    return player

# ­ЪћЌ лћлълЉлљлњлЏл»лЋлю лцлБлЮлџлдлўл« лЪлълЏлБлДлЋлЮлўл» лЪлЏлЋлЋлалљ лњ лГлџлЌлЋлюлЪлЏл»ла лЉлълблљ!!! ­ЪћЌ
bot.get_player = get_player

# ­Ъџђ лцлБлЮлџлдлўл» лЌлљлЪлБлАлџлљ лЉлълблљ - лЊлЏлљлњлЮлФлЎ лЌлљлЪлБлАлџлљлблъла!!! ­Ъџђ
async def main():
    """­ЪЈЂ лълАлЮлълњлЮлљл» лцлБлЮлџлдлўл» лЌлљлЪлБлАлџлљ лЉлълблљ - лњлАлЂ лЮлљлДлўлЮлљлЋлблАл» лЌлћлЋлАлг!!! ­ЪЈЂ"""
    # ­ЪЊЦ лЌлљлЊлалБлЌлџлљ люлълћлБлЏлЋлЎ лА лџлълюлљлЮлћлљлюлў!!! ­ЪЊЦ
    await load_extensions()
    
    # ­Ъџђ лЌлљлЪлБлАлџ лЉлълблљ - лЪлълЋлЦлљлЏлў!!! ­Ъџђ
    async with bot:
        await bot.start(TOKEN)

# ­ЪЈЂ лЌлљлЪлБлАлџ лЉлълблљ - лЪлълЋлЦлљлЏлў!!! ­ЪЈЂ
if __name__ == "__main__":
    try:
        # ­Ъћё лЌлљлЪлБлАлџ лњ лљлАлўлЮлЦлалълЮлЮлълю лалЋлќлўлюлЋ - лАлълњлалЋлюлЋлЮлЮлФлЋ лблЋлЦлЮлълЏлълЊлўлў!!! ­Ъћё
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("РЏћ лЉлълб лълАлблљлЮлълњлЏлЋлЮ лњлалБлДлЮлБл«!!! лћлъ лЮлълњлФлЦ лњлАлблалЋлД!!! РЏћ")
    except Exception as e:
        logger.error(f"­ЪњЦ лџлалўлблўлДлЋлАлџлљл» лълелўлЉлџлљ: {e}!!! лАлалълДлЮлъ лўлАлЪлалљлњлглблЋ!!! ­ЪњЦ")
        sys.exit(1) 