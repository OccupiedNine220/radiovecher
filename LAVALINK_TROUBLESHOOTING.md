# Руководство по устранению неполадок с Lavalink

## Общие проблемы с Lavalink и их решения

### 1. Проблема: Ошибка подключения к Lavalink серверу

В логах видно сообщение:
```
An unexpected error occurred while connecting Node to Lavalink: ""
If this error persists or wavelink is unable to reconnect, please see: https://github.com/PythonistaGuild/Wavelink/issues
```

#### Возможные причины и решения:

1. **Lavalink сервер не запущен или не отвечает**
   - Убедитесь, что Lavalink сервер запущен и работает на порту 2333
   - Используйте `run_lavalink.bat` для запуска Lavalink отдельно от бота
   - Проверьте, что порт 2333 не занят другим приложением

2. **Неверные настройки подключения**
   - Проверьте настройки в файле `.env`:
     - LAVALINK_HOST должен быть "localhost" или "127.0.0.1"
     - LAVALINK_PORT должен быть 2333
     - LAVALINK_PASSWORD должен совпадать с паролем в application.yml

3. **Несовместимость версий**
   - Убедитесь, что вы используете совместимые версии:
     - Java 11, 17 или 21 для Lavalink
     - Wavelink 3.x для Wavelink 3.0+
     - Lavalink 3.x для совместимости с Wavelink 3.x

4. **Отсутствует файл application.yml**
   - Создайте файл application.yml в корневой директории проекта с правильными настройками
   - Используйте скрипт `fix_lavalink.bat` для создания нужных файлов

### 2. Проблема: Порт 2333 уже используется

#### Решения:
- Найдите и завершите процесс, использующий порт 2333:
  ```
  netstat -ano | findstr ":2333"
  taskkill /F /PID <номер_процесса>
  ```
- Измените порт Lavalink в application.yml и .env файле на другой (например, 2334)

### 3. Проблема: Java не установлена или несовместимая версия

#### Решения:
- Установите Java JDK 11, 17 или 21 с сайта https://adoptium.net/
- Добавьте Java в переменную PATH
- Убедитесь, что команда `java -version` выдает правильную версию

### 4. Проблема: Lavalink.jar отсутствует или поврежден

#### Решения:
- Скачайте последнюю версию Lavalink.jar с https://github.com/lavalink-devs/Lavalink/releases
- Используйте `fix_lavalink.bat` для автоматической загрузки Lavalink.jar

## Пошаговая инструкция по диагностике

1. **Запустите скрипт диагностики**
   ```
   debug.bat
   ```

2. **Проверьте версии используемых компонентов**
   - Python: 3.8 или выше
   - Wavelink: 3.x
   - Java: 11, 17 или 21

3. **Проверьте наличие всех необходимых файлов**
   - Lavalink.jar
   - application.yml
   - .env с правильными настройками

4. **Запустите Lavalink сервер отдельно**
   ```
   run_lavalink.bat
   ```
   Убедитесь, что он успешно запустился и работает без ошибок

5. **Проведите тест подключения к Lavalink**
   ```
   test_wavelink.bat
   ```
   Выберите вариант 1, если Lavalink уже запущен

6. **Если всё еще есть проблемы**
   ```
   fix_lavalink.bat
   ```
   Этот скрипт попытается исправить большинство распространенных проблем

## Проблемы с Wavelink 3.x и их решения

1. **Ошибка импорта или некорректная версия Wavelink**
   - Обновите Wavelink до последней версии 3.x:
     ```
     pip install --upgrade "wavelink>=3.0.0"
     ```

2. **Проблемы с API Wavelink 3.x**
   - Обновите код для работы с новым API:
     - Используйте `wavelink.Node` вместо `wavelink.NodePool.create_node`
     - Подключение узлов делайте через `wavelink.Pool.connect(nodes=[node], client=bot)`
     - Используйте новые имена событий и аттрибутов

## Рекомендации по запуску

1. **Для стабильной работы**:
   - Сначала запустите Lavalink отдельно (`run_lavalink.bat`)
   - После успешного запуска Lavalink запустите бота (`run_wavelink3.bat`)

2. **Для проверки настроек**:
   - Используйте `test_wavelink.bat` для проверки подключения

3. **Для устранения проблем**:
   - Используйте `fix_lavalink.bat` для исправления типичных проблем
   - Используйте `debug.bat` для получения подробной информации о системе

## Если ничего не помогает

Если проблемы с Lavalink сохраняются, вы можете запустить бота в режиме без Lavalink:
```
run_ffmpeg.bat
```

Это позволит боту работать, используя только FFMPEG для воспроизведения звука. 